#      ####################################### FINALIZED ###############################################

name: Build & Upload APK
on:
  workflow_call:
    inputs:
      build_type:
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  build-upload:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the code
      uses: actions/checkout@v4

    - name: Set dynamic variables
      run: |
        REPO_NAME="${GITHUB_REPOSITORY##*/}"
        BRANCH_NAME="${GITHUB_REF_NAME}"
        BUILD_TYPE="${{ inputs.build_type }}"

        # Compute PROJECT_NAME from REPO_NAME (everything after first 2 hyphens)
        IFS='-' read -ra PARTS <<< "$REPO_NAME"
        if [ "${#PARTS[@]}" -gt 2 ]; then
          PROJECT_NAME="${PARTS[@]:3}"
          PROJECT_NAME="${PROJECT_NAME// /-}"
        else
          PROJECT_NAME="$REPO_NAME"
        fi

        # Compute ENVIRONMENT
        if [ "$BRANCH_NAME" == "main" ]; then
          ENVIRONMENT="production"
        elif [ "$BRANCH_NAME" == "develop" ]; then
          ENVIRONMENT="staging"
        else
          ENVIRONMENT="development"
        fi

        COMMIT_HASH="${GITHUB_SHA}"
        FILE_NAME="${PROJECT_NAME}-${ENVIRONMENT}-${COMMIT_HASH}.apk"
        FILE_PATH="${PROJECT_NAME}/${ENVIRONMENT}/"

        echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
        echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
        echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
        echo "FILE_PATH=$FILE_PATH" >> $GITHUB_ENV

        # Echo all variables to the workflow log
        echo "==== Dynamic Variables ===="
        echo "REPO_NAME: $REPO_NAME"
        echo "BRANCH_NAME: $BRANCH_NAME"
        echo "PROJECT_NAME: $PROJECT_NAME"
        echo "ENVIRONMENT: $ENVIRONMENT"
        echo "COMMIT_HASH: $COMMIT_HASH"
        echo "FILE_NAME: $FILE_NAME"
        echo "FILE_PATH: $FILE_PATH"
        echo "==========================="

        # input: debug or release
        BUILD_TYPE="${{ inputs.build_type }}"
        # For Gradle task (Debug / Release)
        BUILD_TYPE_CAP="$(tr '[:lower:]' '[:upper:]' <<< ${BUILD_TYPE:0:1})${BUILD_TYPE:1}"
        echo "BUILD_TYPE_CAP=$BUILD_TYPE_CAP" >> $GITHUB_ENV
        echo "BUILD_TYPE_CAP: $BUILD_TYPE_CAP"            

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 21

    - name: Install required Android SDK + NDK
      run: |
        yes | /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "ndk;29.0.13599879"

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build APK
      run: ./gradlew assemble${{env.BUILD_TYPE_CAP}} --stacktrace

    - name: Inspect APK output
      run: ls app/build/outputs/apk/ -R

    # make finding apk (s) dynamic - standard or multi (flavor) builds
    - name: Find APK(s)
      id: find_apk
      run: |
        echo "Finding APKs..."
        for apk in $(find app/build/outputs/apk -name "*-debug.apk"); do
          echo "Found APK: $apk"
          # Save each APK path to a temporary file for later use
          echo "$apk" >> apk_list.txt
        done
        # Save the list to GitHub Actions environment
        echo "APK_LIST_FILE=apk_list.txt" >> $GITHUB_ENV

    # make renaming dynamic - standard or multi (flavor) builds
    - name: Rename APKs
      run: |
        mkdir -p dist
        while IFS= read -r apk; do
          # Extract flavor if present
          FLAVOR=$(basename "$(dirname "$(dirname "$apk")")")
          
          # For simple builds, the flavor folder may be 'debug' or 'app', you can normalize it
          if [ "$FLAVOR" = "${{ inputs.build_type }}" ] || [ "$FLAVOR" = "apk" ]; then  #input type can be debug or release only
            FLAVOR="standard"
          fi

          # Construct new name
          NEW_NAME="${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-${{ env.COMMIT_HASH }}-${FLAVOR}.apk"

          # Copy to dist folder
          cp "$apk" "dist/$NEW_NAME"
          echo "Renamed $apk -> dist/$NEW_NAME"
        done < ${{ env.APK_LIST_FILE }}

    - name: Debug dist folder
      run: |
        echo "Listing dist folder before upload..."
        ls -lh dist || echo "dist does not exist"

    - uses: google-github-actions/auth@v3
      with:
        service_account: ${{ secrets.GCP_SA_EMAIL }}
        workload_identity_provider: 'projects/347148155332/locations/global/workloadIdentityPools/github-actions-pool/providers/github'

    - name: Setup gcloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    # upload whole dist folder - standard or multi (flavor) builds
    - name: Upload APKs to GCS
      uses: google-github-actions/upload-cloud-storage@v2
      with:
        path: dist
        destination: gha-bucket-automation/${{ env.FILE_PATH }}

  ################################ Please read! ############################################
  # Either generate signed url of the file from GCS and link should download the apk instantly.

    # - name: Generate Signed URL
    #   id: signed-url
    #   run: |
    #     echo '${{ secrets.GCP_SA_KEY }}' > sa.json
    #     URL=$(gsutil signurl -d 24h sa.json gs://gha-bucket-automation/${{ env.FILE_PATH }}${{ env.FILE_NAME }} | tail -n1 | awk '{print $NF}')
    #     echo "SIGNED_URL=$URL" >> $GITHUB_ENV

    # - name: Log All Details
    #   if: always()
    #   id: notify
    #   run: |
    #     STATUS="${{ job.status }}"
    #     if [ "$STATUS" == "success" ]; then
    #       EMOJI="✅"
    #       TITLE="New Build Available!"
    #     else
    #       EMOJI="❌"
    #       TITLE="Workflow/Build Failed!"
    #     fi
    #     echo "----------------------------------------"
    #     echo "${EMOJI} ${TITLE} - Build Details:"
    #     echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
    #     echo "title=$TITLE" >> $GITHUB_OUTPUT
    #     echo ""
    #     echo "Project: ${{ env.PROJECT_NAME }}"
    #     echo "Repo: ${{ env.REPO_NAME }}"
    #     echo "Branch: ${{ github.ref_name }}"
    #     echo "Environment: ${{ env.ENVIRONMENT }}"
    #     echo "Commit: ${{ github.sha }}"
    #     echo "Download the APK file from the artifact of this workflow run."
    #     echo "----------------------------------------"

    # - name: Create APK Download Page
    #   if: always()
    #   run: |
    #     echo "<html><body>" > download.html
    #     echo "<a href='${SIGNED_URL}' download>Click here to download APK (The link is valid for only 24 hrs)</a>" >> download.html
    #     echo "</body></html>" >> download.html
  
  ################################ Please read! ############################################
  # Or, simply upload as an artifact

    # Failing because of quota limit
    # - uses: actions/upload-artifact@v4
    #   with:
    #     name: my-artifacts
    #     path: dist/*.apk
